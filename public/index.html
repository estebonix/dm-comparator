<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de DMs (IA)</title>
    <!-- Importamos una fuente bonita de Google -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Vinculamos el archivo CSS externo -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- CREADOR DE PERSONAJE -->
    <div id="setup-screen">
        <div>
            <h1>üßô‚Äç‚ôÇÔ∏è Creador de H√©roe</h1>
            <p class="subtitle">Dise√±a tu personaje y deja que las IAs narren tu destino.</p>
        </div>

        <div class="char-form">
            <div class="form-group full-width">
                <label>Nombre del H√©roe</label>
                <input type="text" id="char-name" class="setup-input" placeholder="Ej: Arin Bjornsson">
            </div>

            <div class="form-group">
                <label>Raza</label>
                <select id="char-race" class="setup-select">
                    <option value="Humano">Humano</option>
                    <option value="Elfo">Elfo</option>
                    <option value="Enano">Enano</option>
                    <option value="Mediano">Mediano</option>
                    <option value="Orco">Orco</option>
                    <option value="Tiefling">Tiefling</option>
                    <option value="Drac√≥nido">Drac√≥nido</option>
                </select>
            </div>

            <div class="form-group">
                <label>Clase</label>
                <select id="char-class" class="setup-select">
                    <option value="Guerrero">Guerrero</option>
                    <option value="Mago">Mago</option>
                    <option value="P√≠caro">P√≠caro</option>
                    <option value="Cl√©rigo">Cl√©rigo</option>
                    <option value="Explorador">Explorador</option>
                    <option value="Palad√≠n">Palad√≠n</option>
                    <option value="Bardo">Bardo</option>
                    <option value="B√°rbaro">B√°rbaro</option>
                </select>
            </div>

            <div class="form-group">
                <label>Alineamiento</label>
                <select id="char-align" class="setup-select">
                    <option value="Legal Bueno">Legal Bueno</option>
                    <option value="Neutral Bueno">Neutral Bueno</option>
                    <option value="Ca√≥tico Bueno">Ca√≥tico Bueno</option>
                    <option value="Legal Neutral">Legal Neutral</option>
                    <option value="Neutral Aut√©ntico">Neutral Aut√©ntico</option>
                    <option value="Ca√≥tico Neutral">Ca√≥tico Neutral</option>
                    <option value="Legal Malvado">Legal Malvado</option>
                    <option value="Neutral Malvado">Neutral Malvado</option>
                    <option value="Ca√≥tico Malvado">Ca√≥tico Malvado</option>
                </select>
            </div>

            <div class="form-group">
                <label>Trasfondo</label>
                <select id="char-bg" class="setup-select">
                    <option value="Soldado">Soldado</option>
                    <option value="Criminal">Criminal</option>
                    <option value="Erudito">Erudito</option>
                    <option value="Noble">Noble</option>
                    <option value="H√©roe del Pueblo">H√©roe del Pueblo</option>
                    <option value="Acolito">Ac√≥lito</option>
                    <option value="Ermita√±o">Ermita√±o</option>
                </select>
            </div>
        </div>
        
        <button onclick="startGame()" class="main-btn">COMENZAR AVENTURA</button>
    </div>

    <!-- PANTALLA DE JUEGO -->
    <div id="game-screen">
        <div class="arena">
            <div class="column">
                <h2>Llama 3.1 8B (R√°pido)</h2>
                <div class="log-container" id="log-1"></div>
            </div>
            <div class="column">
                <h2>Llama 3.3 70B (Inteligente)</h2>
                <div class="log-container" id="log-2"></div>
            </div>
        </div>

        <div class="loader" id="loader">‚ú® Los DMs est√°n tejiendo el destino...</div>

        <!-- Panel de control -->
        <div class="input-area">
            
            <!-- INPUT OCULTO PARA ALMACENAR EL VALOR SELECCIONADO -->
            <input type="hidden" id="dice-select" value="none">

            <!-- DROPDOWN PERSONALIZADO -->
            <div class="custom-dropdown" id="dice-dropdown">
                <div class="dropdown-btn" onclick="toggleDiceMenu()">
                    <div class="selected-value" id="selected-dice-display">
                        <span>üö´</span> <span>Sin dado</span>
                    </div>
                    <span class="arrow-icon">‚ñº</span>
                </div>
                
                <div class="dropdown-content" id="dice-options">
                    <div class="dropdown-item" onclick="selectDice('none', 'üö´', 'Sin dado')">
                        <span>üö´</span> Sin dado
                    </div>
                    <div class="dropdown-item" onclick="selectDice('20', getDiceSvg('d20'), 'd20 (Acierto)')">
                        <!-- SVG d20 -->
                        <svg class="dice-svg" viewBox="0 0 24 24"><path d="M12 2L2 8l10 6 10-6-10-6zm0 2.2l6.5 3.9-6.5 3.9-6.5-3.9L12 4.2zM2.2 9.5l9.3 5.5v9l-9.3-5.5v-9zm19.6 0v9l-9.3 5.5v-9l9.3-5.5z"/></svg>
                        d20 (Acierto)
                    </div>
                    <div class="dropdown-item" onclick="selectDice('12', getDiceSvg('d12'), 'd12 (Da√±o)')">
                        <!-- SVG d12 -->
                        <svg class="dice-svg" viewBox="0 0 24 24"><path d="M12 2l8.5 6-3.3 9.9H6.8L3.5 8 12 2zm0 2.5L5.8 8l2.2 6.5h8L18.2 8 12 4.5z"/></svg>
                        d12 (Da√±o)
                    </div>
                    <div class="dropdown-item" onclick="selectDice('10', getDiceSvg('d10'), 'd10 (Da√±o)')">
                        <!-- SVG d10 -->
                        <svg class="dice-svg" viewBox="0 0 24 24"><path d="M12 2L4 12l8 10 8-10-8-10zm0 2.5l5.5 8.7L12 19.3 6.5 13.2 12 4.5z"/></svg>
                        d10 (Da√±o)
                    </div>
                    <div class="dropdown-item" onclick="selectDice('8', getDiceSvg('d8'), 'd8 (Da√±o)')">
                        <!-- SVG d8 -->
                        <svg class="dice-svg" viewBox="0 0 24 24"><path d="M12 2L2 12l10 10 10-10L12 2zm0 2.8L19.2 12 12 19.2 4.8 12 12 4.8z"/></svg>
                        d8 (Da√±o)
                    </div>
                    <div class="dropdown-item" onclick="selectDice('6', getDiceSvg('d6'), 'd6 (Corto)')">
                        <!-- SVG d6 -->
                        <svg class="dice-svg" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2" stroke-width="2"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="16" cy="8" r="1.5" fill="currentColor"/><circle cx="8" cy="16" r="1.5" fill="currentColor"/></svg>
                        d6 (Corto)
                    </div>
                    <div class="dropdown-item" onclick="selectDice('4', getDiceSvg('d4'), 'd4 (Poci√≥n)')">
                        <!-- SVG d4 -->
                        <svg class="dice-svg" viewBox="0 0 24 24"><path d="M12 2L3 20h18L12 2zm0 3.5l6.5 13h-13l6.5-13z"/></svg>
                        d4 (Poci√≥n)
                    </div>
                    <div class="dropdown-item" onclick="selectDice('100', 'üíØ', 'd100 (%)')">
                        <span>üíØ</span> d100 (%)
                    </div>
                </div>
            </div>
            
            <input type="text" id="user-action" placeholder="Describe tu acci√≥n heroica..." onkeypress="handleEnter(event)" autocomplete="off">
            <button onclick="sendTurn()" id="btn-send" class="main-btn">ENVIAR</button>
        </div>
    </div>

    <script>
        let currentGameId = null;

        // --- Funciones del Dropdown Personalizado ---
        
        function toggleDiceMenu() {
            const dropdown = document.getElementById('dice-dropdown');
            const content = document.getElementById('dice-options');
            content.classList.toggle('show');
            dropdown.classList.toggle('active');
        }

        // Cierra el dropdown si clicas fuera
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-btn') && !event.target.matches('.dropdown-btn *')) {
                const contents = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < contents.length; i++) {
                    const openDropdown = contents[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                        document.getElementById('dice-dropdown').classList.remove('active');
                    }
                }
            }
        }

        function getDiceSvg(type) {
            // Helper para devolver el HTML del SVG seg√∫n el tipo, para pintar el seleccionado
            // Copiamos los paths definidos en el HTML arriba
            const paths = {
                'd20': 'M12 2L2 8l10 6 10-6-10-6zm0 2.2l6.5 3.9-6.5 3.9-6.5-3.9L12 4.2zM2.2 9.5l9.3 5.5v9l-9.3-5.5v-9zm19.6 0v9l-9.3 5.5v-9l9.3-5.5z',
                'd12': 'M12 2l8.5 6-3.3 9.9H6.8L3.5 8 12 2zm0 2.5L5.8 8l2.2 6.5h8L18.2 8 12 4.5z',
                'd10': 'M12 2L4 12l8 10 8-10-8-10zm0 2.5l5.5 8.7L12 19.3 6.5 13.2 12 4.5z',
                'd8': 'M12 2L2 12l10 10 10-10L12 2zm0 2.8L19.2 12 12 19.2 4.8 12 12 4.8z',
                'd4': 'M12 2L3 20h18L12 2zm0 3.5l6.5 13h-13l6.5-13z',
                'd6': '<rect x="4" y="4" width="16" height="16" rx="2" ry="2" stroke-width="2"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="16" cy="8" r="1.5" fill="currentColor"/><circle cx="8" cy="16" r="1.5" fill="currentColor"/>'
            };
            
            if (type === 'd6') return `<svg class="dice-svg" viewBox="0 0 24 24">${paths.d6}</svg>`;
            if (paths[type]) return `<svg class="dice-svg" viewBox="0 0 24 24"><path d="${paths[type]}"/></svg>`;
            return 'üé≤';
        }

        function selectDice(value, iconHtml, text) {
            // 1. Actualizar valor oculto (l√≥gica original)
            document.getElementById('dice-select').value = value;
            
            // 2. Actualizar visualizaci√≥n
            const display = document.getElementById('selected-dice-display');
            
            // Si es un SVG string (como el de getDiceSvg o el HTML literal), lo ponemos tal cual
            // Si es un emoji simple, lo ponemos en span
            if (iconHtml.includes('<svg') || iconHtml.includes('üö´') || iconHtml.includes('üíØ')) {
                 display.innerHTML = `<span>${iconHtml}</span> <span>${text}</span>`;
            } else {
                 display.innerHTML = `<span>${iconHtml}</span> <span>${text}</span>`;
            }

            // 3. Cerrar men√∫
            toggleDiceMenu();
        }

        async function startGame() {
            // Recoger datos del formulario
            const name = document.getElementById('char-name').value.trim() || "Aventurero Desconocido";
            const race = document.getElementById('char-race').value;
            const charClass = document.getElementById('char-class').value;
            const align = document.getElementById('char-align').value;
            const bg = document.getElementById('char-bg').value;

            // CONSTRUCCI√ìN DEL PROMPT ELABORADO
            const elaboratePrompt = `
Eres un Dungeon Master experto de Dungeons & Dragons 5e. Tu trabajo es narrar una aventura inmersiva, oscura y emocionante.

DETALLES DEL JUGADOR:
- Nombre: ${name}
- Raza: ${race}
- Clase: ${charClass}
- Alineamiento: ${align}
- Trasfondo: ${bg}

REGLAS DE DIRECCI√ìN:
1. Act√∫a como el DM: describe el entorno, los NPCs y las consecuencias. NUNCA decidas las acciones ni los di√°logos del jugador.
2. S√© descriptivo: usa los sentidos (olores, sonidos, atm√≥sfera).
3. Mec√°nicas: Si el jugador hace una tirada de dados (ej: [üé≤ Tirada d20: 15]), interpreta el resultado. Si es bajo, falla con consecuencias; si es alto, ten √©xito.
4. Contexto Inicial: Comienza la aventura en una situaci√≥n interesante relacionada con su trasfondo de ${bg}.
            `.trim();

            // UI Updates
            const btn = document.querySelector('#setup-screen button');
            btn.innerText = "Invocando IAs...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ systemPrompt: elaboratePrompt })
                });
                const data = await res.json();
                
                if (data.gameId) {
                    currentGameId = data.gameId;
                    
                    const setup = document.getElementById('setup-screen');
                    setup.style.opacity = '0';
                    setTimeout(() => {
                        setup.style.display = 'none';
                        const game = document.getElementById('game-screen');
                        game.style.display = 'flex';
                        game.style.animation = 'fadeIn 0.5s ease-out';
                        
                        if (data.dm1) addMessageToLog(1, 'ai', data.dm1);
                        if (data.dm2) addMessageToLog(2, 'ai', data.dm2);
                        
                    }, 300);
                }
            } catch (err) {
                alert("Error conectando con el servidor");
                btn.innerText = "COMENZAR AVENTURA";
                btn.disabled = false;
            }
        }

        async function sendTurn() {
            const input = document.getElementById('user-action');
            // Usamos el input oculto ahora
            const dieValue = document.getElementById('dice-select').value;
            
            let actionText = input.value.trim();

            if (!actionText && dieValue === 'none') return;

            let displayAction = actionText; 

            if (dieValue !== 'none') {
                const sides = parseInt(dieValue);
                const roll = Math.floor(Math.random() * sides) + 1;
                // Usamos colores para el dado seg√∫n si es cr√≠tico o pifia visualmente
                let colorClass = '#a78bfa';
                if(sides === 20 && roll === 20) colorClass = '#10b981'; // Verde cr√≠tico
                if(sides === 20 && roll === 1) colorClass = '#ef4444';  // Rojo pifia

                const diceTag = `[üé≤ Tirada d${sides}: <strong style="color:${colorClass}">${roll}</strong>]`;
                
                if (displayAction) {
                    displayAction += " " + diceTag;
                } else {
                    displayAction = diceTag;
                }
            }

            input.value = '';
            const btn = document.getElementById('btn-send');
            btn.disabled = true;
            document.getElementById('loader').style.display = 'block';

            addMessageToLog(1, 'user', displayAction, true);
            addMessageToLog(2, 'user', displayAction, true);

            // Reseteamos el selector de dados VISUAL y el valor oculto
            if (dieValue !== 'none') {
               selectDice('none', 'üö´', 'Sin dado');
            }

            try {
                const res = await fetch('/api/turn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gameId: currentGameId, userAction: displayAction })
                });
                
                const data = await res.json();

                addMessageToLog(1, 'ai', data.dm1 || "Error recibiendo respuesta");
                addMessageToLog(2, 'ai', data.dm2 || "Error recibiendo respuesta");

            } catch (err) {
                console.error(err);
                alert("Error en el turno. Revisa la consola.");
            } finally {
                btn.disabled = false;
                document.getElementById('loader').style.display = 'none';
                input.focus();
            }
        }

        function addMessageToLog(dmNumber, role, text, isHtml = false) {
            const container = document.getElementById(`log-${dmNumber}`);
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            
            if (isHtml) {
                div.innerHTML = text;
            } else {
                div.innerHTML = text.replace(/\n/g, '<br>');
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendTurn();
        }
    </script>
</body>
</html>