<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de DMs (IA)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- OVERLAY DE ANIMACI√ìN DE DADOS -->
    <div id="dice-overlay">
        <div class="dice-stage">
            <div id="dice-anim-container">
                <!-- Aqu√≠ se inyectar√° el SVG del dado -->
            </div>
            <div id="dice-anim-result" class="dice-result-number">20</div>
        </div>
        <h2 style="margin-top: 20px; color: #fff; text-shadow: 0 0 10px black;">¬°El destino decide!</h2>
    </div>

    <!-- PANTALLA DE CONFIGURACI√ìN Y MEN√ö -->
    <div id="setup-screen">
        
        <!-- Secci√≥n Superior: Creador de Personaje -->
        <div class="creator-column">
            <div>
                <h1>üìú Cr√≥nicas del H√©roe</h1>
                <p class="subtitle">Forja tu leyenda y desaf√≠a a los Dioses.</p>
            </div>

            <div class="char-form">
                <div class="form-group full-width">
                    <label>Nombre del H√©roe</label>
                    <input type="text" id="char-name" class="setup-input" placeholder="Ej: Arin Bjornsson">
                </div>

                <div class="form-group">
                    <label>Raza</label>
                    <select id="char-race" class="setup-select">
                        <option value="Humano">Humano</option>
                        <option value="Elfo">Elfo</option>
                        <option value="Enano">Enano</option>
                        <option value="Mediano">Mediano</option>
                        <option value="Orco">Orco</option>
                        <option value="Tiefling">Tiefling</option>
                        <option value="Drac√≥nido">Drac√≥nido</option>
                        <option value="Gnomo">Gnomo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Clase</label>
                    <select id="char-class" class="setup-select">
                        <option value="Guerrero">Guerrero</option>
                        <option value="Mago">Mago</option>
                        <option value="P√≠caro">P√≠caro</option>
                        <option value="Cl√©rigo">Cl√©rigo</option>
                        <option value="Explorador">Explorador</option>
                        <option value="Palad√≠n">Palad√≠n</option>
                        <option value="Bardo">Bardo</option>
                        <option value="B√°rbaro">B√°rbaro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Alineamiento</label>
                    <select id="char-align" class="setup-select">
                        <option value="Legal Bueno">Legal Bueno</option>
                        <option value="Neutral Bueno">Neutral Bueno</option>
                        <option value="Ca√≥tico Bueno">Ca√≥tico Bueno</option>
                        <option value="Legal Neutral">Legal Neutral</option>
                        <option value="Neutral Aut√©ntico">Neutral Aut√©ntico</option>
                        <option value="Ca√≥tico Neutral">Ca√≥tico Neutral</option>
                        <option value="Legal Malvado">Legal Malvado</option>
                        <option value="Neutral Malvado">Neutral Malvado</option>
                        <option value="Ca√≥tico Malvado">Ca√≥tico Malvado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Trasfondo</label>
                    <select id="char-bg" class="setup-select">
                        <option value="Soldado">Soldado</option>
                        <option value="Criminal">Criminal</option>
                        <option value="Erudito">Erudito</option>
                        <option value="Noble">Noble</option>
                        <option value="H√©roe del Pueblo">H√©roe del Pueblo</option>
                        <option value="Acolito">Ac√≥lito</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Compa√±√≠a</label>
                    <select id="party-size" class="setup-select">
                        <option value="Lobo Solitario">Lobo Solitario</option>
                        <option value="D√∫o">D√∫o (Con 1 Aliado)</option>
                        <option value="Grupo Peque√±o">Grupo Peque√±o (3 PJs)</option>
                        <option value="Grupo Cl√°sico">Grupo Cl√°sico (4-5 PJs)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Tono</label>
                    <select id="story-tone" class="setup-select">
                        <option value="Fantas√≠a √âpica">Fantas√≠a √âpica</option>
                        <option value="Fantas√≠a Oscura">Fantas√≠a Oscura</option>
                        <option value="Misterio">Misterio</option>
                        <option value="Terror">Terror</option>
                        <option value="Comedia">Comedia</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label>Rumbo de la Historia</label>
                    <textarea id="story-context" class="setup-input" placeholder="Ej: Buscamos una cura para una plaga m√°gica..."></textarea>
                </div>
            </div>
            
            <button onclick="startGame()" id="btn-start-game" class="main-btn">‚öîÔ∏è Comenzar Nueva Aventura ‚öîÔ∏è</button>
        </div>

        <!-- Secci√≥n Inferior: Historial de Partidas -->
        <div class="history-column">
            <h2>Partidas Guardadas</h2>
            <div id="games-list" class="history-list">
                <div style="color: #666; font-style: italic; padding: 10px;">Consultando los archivos...</div>
            </div>
        </div>
    </div>

    <!-- PANTALLA DE JUEGO -->
    <div id="game-screen">
        <div class="char-hud">
            <div class="hud-avatar">üõ°Ô∏è</div>
            <div class="hud-item">
                <span class="hud-label">H√©roe</span>
                <span class="hud-value" id="hud-name">-</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">Clase/Raza</span>
                <span class="hud-value" id="hud-details">-</span>
            </div>
            
            <button onclick="location.reload()" class="back-btn">‚ùå Salir al Men√∫</button>
        </div>

        <div class="arena">
            <div class="column">
                <h2>üìú Llama 3.1 8B (R√°pido)</h2>
                <div class="log-container" id="log-1"></div>
            </div>
            <div class="column">
                <h2>üîÆ Llama 3.3 70B (Inteligente)</h2>
                <div class="log-container" id="log-2"></div>
            </div>
        </div>

        <div class="loader" id="loader">üïØÔ∏è Los or√°culos consultan los pergaminos... üïØÔ∏è</div>

        <div class="input-area">
            <input type="hidden" id="dice-select" value="none">

            <!-- DROPDOWN MEJORADO -->
            <div class="custom-dropdown" id="dice-dropdown">
                <div class="dropdown-btn" onclick="toggleDiceMenu()">
                    <div class="selected-value" id="selected-dice-display">
                        <span>üö´</span> <span>Elegir Dado</span>
                    </div>
                    <span class="arrow-icon">‚ñº</span>
                </div>
                
                <div class="dropdown-content" id="dice-options">
                    <!-- Las opciones de dados (d20, d12, etc.) -->
                    <div class="dropdown-item" onclick="triggerDiceRoll('20', getDiceSvg('d20'))">
                        <svg class="dice-svg" viewBox="0 0 512 512"><path d="M256 0L58.6 122.3l49.8 199.1L256 464l147.6-142.6 49.8-199.1L256 0zm0 41.1l157.9 97.8-87.3 125.7L256 376.1l-70.6-111.5-87.3-125.7L256 41.1zm-18.9 148l-98-34.9 66.8 96 31.2 49.3zm37.8 0v110.4l31.2-49.3 66.8-96-98 34.9z"/></svg>
                        d20 (Acierto)
                    </div>
                    <div class="dropdown-item" onclick="triggerDiceRoll('12', getDiceSvg('d12'))">
                        <svg class="dice-svg" viewBox="0 0 512 512"><path d="M256 48L95.5 164.5l61.3 189h198.4l61.3-189L256 48zm0 50.4l112.5 81.6-43 132.3H186.5l-43-132.3L256 98.4z"/></svg>
                        d12 (Da√±o)
                    </div>
                    <div class="dropdown-item" onclick="triggerDiceRoll('10', getDiceSvg('d10'))">
                        <svg class="dice-svg" viewBox="0 0 512 512"><path d="M256 16L64 256l192 240 192-240L256 16zm0 53.3l122.7 154.7L256 378.7 133.3 224 256 69.3z"/></svg>
                        d10 (Da√±o)
                    </div>
                    <div class="dropdown-item" onclick="triggerDiceRoll('8', getDiceSvg('d8'))">
                        <svg class="dice-svg" viewBox="0 0 512 512"><path d="M256 16L32 256l224 240 224-240L256 16zm0 53.3l138.7 149.3L256 368 117.3 218.7 256 69.3z"/></svg>
                        d8 (Da√±o)
                    </div>
                    <div class="dropdown-item" onclick="triggerDiceRoll('6', getDiceSvg('d6'))">
                        <svg class="dice-svg" viewBox="0 0 512 512"><path d="M64 64v384h384V64H64zm96 96c17.7 0 32 14.3 32 32s-14.3 32-32 32-32-14.3-32-32 14.3-32 32-32zm0 160c17.7 0 32 14.3 32 32s-14.3 32-32 32-32-14.3-32-32 14.3-32 32-32zm192 0c17.7 0 32 14.3 32 32s-14.3 32-32 32-32-14.3-32-32 14.3-32 32-32zm0-160c17.7 0 32 14.3 32 32s-14.3 32-32 32-32-14.3-32-32 14.3-32 32-32z"/></svg>
                        d6 (Corto)
                    </div>
                    <div class="dropdown-item" onclick="triggerDiceRoll('4', getDiceSvg('d4'))">
                        <svg class="dice-svg" viewBox="0 0 512 512"><path d="M256 16L32 400h448L256 16zm0 74.7L392.5 352H119.5L256 90.7z"/></svg>
                        d4 (Poci√≥n)
                    </div>
                </div>
            </div>
            
            <input type="text" id="user-action" placeholder="Narra tu acci√≥n..." onkeypress="handleEnter(event)" autocomplete="off">
            <button onclick="sendTurn()" id="btn-send" class="main-btn">ENVIAR</button>
        </div>
    </div>

    <script>
        let currentGameId = null;

        document.addEventListener('DOMContentLoaded', loadGamesList);

        // --- L√≥gica de Juegos --- (Igual que antes)
        async function loadGamesList() {
            const list = document.getElementById('games-list');
            try {
                const res = await fetch('/api/games');
                const games = await res.json();
                
                if(games.length === 0) {
                    list.innerHTML = '<div style="padding:10px; color:#666;">No hay cr√≥nicas guardadas.</div>';
                    return;
                }

                list.innerHTML = '';
                games.forEach(g => {
                    const date = new Date(g.created_at).toLocaleDateString() + ' ' + new Date(g.created_at).toLocaleTimeString().slice(0,5);
                    const nameMatch = g.system_prompt.match(/Nombre: (.*?)\n/);
                    const heroName = nameMatch ? nameMatch[1] : `Aventura #${g.id}`;

                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="history-info" onclick="loadGame(${g.id}, '${heroName}')">
                            <span class="history-name">${heroName}</span>
                            <span class="history-date">${date}</span>
                        </div>
                        <button class="delete-btn" onclick="deleteGame(${g.id})" title="Borrar Cr√≥nica">üóëÔ∏è</button>
                    `;
                    list.appendChild(item);
                });
            } catch(e) {
                console.error(e);
                list.innerHTML = '<div style="color:red">Error cargando cr√≥nicas.</div>';
            }
        }

        async function deleteGame(id) {
            if(!confirm("¬øEst√°s seguro de querer quemar este pergamino? No hay vuelta atr√°s.")) return;
            try {
                await fetch(`/api/games/${id}`, { method: 'DELETE' });
                loadGamesList();
            } catch(e) {
                alert("Error al borrar.");
            }
        }

        async function loadGame(id, heroName) {
            currentGameId = id;
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('hud-name').innerText = heroName;
            document.getElementById('hud-details').innerText = "Cargado";
            
            const log1 = document.getElementById('log-1');
            const log2 = document.getElementById('log-2');
            log1.innerHTML = ''; 
            log2.innerHTML = '';

            try {
                const res = await fetch(`/api/history/${id}`);
                const messages = await res.json();
                
                messages.forEach(msg => {
                    const txt = parseSimpleMarkdown(msg.content);
                    if(msg.dm_id === 0) {
                        addMessageToLog(1, 'user', txt, true);
                        addMessageToLog(2, 'user', txt, true);
                    } else if (msg.dm_id === 1) {
                        addMessageToLog(1, 'ai', txt, true);
                    } else if (msg.dm_id === 2) {
                        addMessageToLog(2, 'ai', txt, true);
                    }
                });
            } catch(e) {
                console.error(e);
            }
        }

        // --- NUEVA L√ìGICA DE ANIMACI√ìN DE DADOS ---
        
        function toggleDiceMenu() {
            const dropdown = document.getElementById('dice-dropdown');
            const content = document.getElementById('dice-options');
            content.classList.toggle('show');
            dropdown.classList.toggle('active');
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-btn') && !event.target.matches('.dropdown-btn *')) {
                const contents = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < contents.length; i++) {
                    const openDropdown = contents[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                        document.getElementById('dice-dropdown').classList.remove('active');
                    }
                }
            }
        }

        function getDiceSvg(type) {
            const paths = {
                'd20': 'M256 0L58.6 122.3l49.8 199.1L256 464l147.6-142.6 49.8-199.1L256 0zm0 41.1l157.9 97.8-87.3 125.7L256 376.1l-70.6-111.5-87.3-125.7L256 41.1zm-18.9 148l-98-34.9 66.8 96 31.2 49.3zm37.8 0v110.4l31.2-49.3 66.8-96-98 34.9z',
                'd12': 'M256 48L95.5 164.5l61.3 189h198.4l61.3-189L256 48zm0 50.4l112.5 81.6-43 132.3H186.5l-43-132.3L256 98.4z',
                'd10': 'M256 16L64 256l192 240 192-240L256 16zm0 53.3l122.7 154.7L256 378.7 133.3 224 256 69.3z',
                'd8': 'M256 16L32 256l224 240 224-240L256 16zm0 53.3l138.7 149.3L256 368 117.3 218.7 256 69.3z',
                'd6': 'M64 64v384h384V64H64zm96 96c17.7 0 32 14.3 32 32s-14.3 32-32 32-32-14.3-32-32 14.3-32 32-32zm0 160c17.7 0 32 14.3 32 32s-14.3 32-32 32-32-14.3-32-32 14.3-32 32-32zm192 0c17.7 0 32 14.3 32 32s-14.3 32-32 32-32-14.3-32-32 14.3-32 32-32zm0-160c17.7 0 32 14.3 32 32s-14.3 32-32 32-32-14.3-32-32 14.3-32 32-32z',
                'd4': 'M256 16L32 400h448L256 16zm0 74.7L392.5 352H119.5L256 90.7z'
            };
            if(paths[type]) return `<svg class="dice-anim-svg" viewBox="0 0 512 512"><path d="${paths[type]}"/></svg>`;
            return 'üé≤';
        }

        // Funci√≥n principal que desencadena todo
        function triggerDiceRoll(sidesStr, svgHtml) {
            // 1. Cerrar men√∫
            toggleDiceMenu();
            
            // 2. Calcular resultado
            const sides = parseInt(sidesStr);
            const roll = Math.floor(Math.random() * sides) + 1;
            
            // 3. Mostrar Overlay y Preparar Animaci√≥n
            const overlay = document.getElementById('dice-overlay');
            const container = document.getElementById('dice-anim-container');
            const resultElem = document.getElementById('dice-anim-result');
            
            container.innerHTML = svgHtml; // Insertar SVG
            resultElem.innerText = roll;
            resultElem.classList.remove('show');
            
            // Resetear animaci√≥n
            container.classList.remove('rolling');
            void container.offsetWidth; // Trigger reflow
            
            // Mostrar y Animar
            overlay.style.display = 'flex';
            container.classList.add('rolling');
            
            // 4. Secuencia temporal
            setTimeout(() => {
                // Mostrar n√∫mero
                resultElem.classList.add('show');
            }, 1200); // Un poco antes de terminar la rotaci√≥n

            setTimeout(() => {
                // Cerrar y Enviar
                overlay.style.display = 'none';
                sendRollResult(sides, roll);
            }, 2500); // Tiempo para ver el resultado
        }

        // Env√≠o autom√°tico tras la animaci√≥n
        function sendRollResult(sides, roll) {
            const input = document.getElementById('user-action');
            let actionText = input.value.trim();
            
            // Colores para el log
            let colorClass = '#a78bfa';
            if(sides === 20 && roll === 20) colorClass = '#10b981'; 
            if(sides === 20 && roll === 1) colorClass = '#ef4444'; 

            const diceTag = `<span class="dice-result">[üé≤ d${sides}: <strong style="color:${colorClass}">${roll}</strong>]</span>`;
            
            let displayAction = actionText ? `${actionText} ${diceTag}` : diceTag;
            
            // Enviar
            performTurn(displayAction);
            input.value = ''; // Limpiar input si hab√≠a texto
        }

        function parseSimpleMarkdown(text) {
            if (!text) return "";
            let html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^- (.*)$/gm, '<ul><li>$1</li></ul>')
                .replace(/\n/g, '<br>');
            html = html.replace(/<\/ul><br><ul>/g, ''); 
            return html;
        }

        async function startGame() {
            const name = document.getElementById('char-name').value.trim() || "Aventurero Desconocido";
            const race = document.getElementById('char-race').value;
            const charClass = document.getElementById('char-class').value;
            const align = document.getElementById('char-align').value;
            const bg = document.getElementById('char-bg').value;
            const partySize = document.getElementById('party-size').value;
            // CONSTRUIR PROMPT EXTENDIDO
            const elaboratePrompt = `
Eres un Dungeon Master experto de Dungeons & Dragons 5e. Tu trabajo es narrar una aventura inmersiva y emocionante.

DETALLES DEL JUGADOR:
- Nombre: ${name}
- Raza: ${race}
- Clase: ${charClass}
- Alineamiento: ${align}
- Trasfondo: ${bg}

CONFIGURACI√ìN:
- Compa√±√≠a: ${partySize}.
- Tono: ${tone}.
- Objetivo: ${storyContext || "A elecci√≥n del DM."}

REGLAS DE DIRECCI√ìN (IMPORTANTE):
1. **Act√∫a como el DM**: describe el entorno, los NPCs y las consecuencias. NUNCA decidas las acciones, pensamientos ni di√°logos del jugador.
2. **GU√çA AL JUGADOR**: No termines con un simple "¬øqu√© haces?". Al final de tu descripci√≥n, **sugiere siempre 2 o 3 opciones claras** de lo que podr√≠a hacer el personaje en esa situaci√≥n (ej: "Podr√≠as intentar forzar la puerta, buscar otra entrada por la ventana o escuchar si hay alguien dentro").
3. **SOLICITA TIRADAS**: Cuando el jugador elija una acci√≥n con riesgo de fallo, o si la situaci√≥n lo requiere (como percibir un peligro), **DET√âN la narraci√≥n y pide expl√≠citamente una tirada** (ej: "Haz una tirada de Sigilo" o "Tira Iniciativa"). No asumas el √©xito sin ver el dado.
4. **Interpreta los Dados**: Si el mensaje del jugador incluye una tirada (ej: [üé≤ 15]), usa ese n√∫mero para determinar el √©xito o fracaso compar√°ndolo con una CD oculta.
5. **Mec√°nicas D&D 5e**:
   - Usa ventaja/desventaja si aplica.
   - Gestiona inventario y salud narrativamente.
   - En combate, usa turnos.
            `.trim();

            // CORRECCI√ìN: Usamos el ID espec√≠fico del bot√≥n para evitar errores
            const btn = document.getElementById('btn-start-game');
            btn.innerText = "Invocando IAs...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ systemPrompt: elaboratePrompt })
                });
                const data = await res.json();
                
                if (data.gameId) {
                    currentGameId = data.gameId;
                    document.getElementById('setup-screen').style.display = 'none';
                    document.getElementById('game-screen').style.display = 'flex';
                    document.getElementById('log-1').innerHTML = '';
                    document.getElementById('log-2').innerHTML = '';

                    if (data.dm1) addMessageToLog(1, 'ai', parseSimpleMarkdown(data.dm1), true);
                    if (data.dm2) addMessageToLog(2, 'ai', parseSimpleMarkdown(data.dm2), true);
                }
            } catch (err) {
                alert("Error conectando con el servidor");
                btn.innerText = "COMENZAR AVENTURA";
                btn.disabled = false;
            }
        }

        // Funci√≥n manual "ENVIAR" (sin dado)
        async function sendTurn() {
            const input = document.getElementById('user-action');
            let actionText = input.value.trim();
            if (!actionText) return;
            performTurn(actionText);
            input.value = '';
        }

        // L√≥gica central de env√≠o al backend
        async function performTurn(displayText) {
            const btn = document.getElementById('btn-send');
            btn.disabled = true;
            document.getElementById('loader').style.display = 'block';

            addMessageToLog(1, 'user', displayText, true);
            addMessageToLog(2, 'user', displayText, true);

            try {
                const res = await fetch('/api/turn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gameId: currentGameId, userAction: displayText })
                });
                
                const data = await res.json();

                addMessageToLog(1, 'ai', parseSimpleMarkdown(data.dm1) || "Error", true);
                addMessageToLog(2, 'ai', parseSimpleMarkdown(data.dm2) || "Error", true);

            } catch (err) {
                console.error(err);
                alert("Error en el turno. Revisa la consola.");
            } finally {
                btn.disabled = false;
                document.getElementById('loader').style.display = 'none';
                const input = document.getElementById('user-action');
                input.focus();
            }
        }

        function addMessageToLog(dmNumber, role, text, isHtml = false) {
            const container = document.getElementById(`log-${dmNumber}`);
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            
            if (isHtml) {
                div.innerHTML = text;
            } else {
                div.innerText = text;
            }
            
            container.appendChild(div);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendTurn();
        }
    </script>
</body>
</html>